diff -N -r -u -w rpm-4.15.0/misc/fts.c rpm-4.15.0-patched/misc/fts.c
--- rpm-4.15.0/misc/fts.c	2019-06-26 15:17:31.420985000 +0000
+++ rpm-4.15.0-patched/misc/fts.c	2019-10-04 09:12:11.801166480 +0000
@@ -51,6 +51,12 @@
 #else
 
 /* Conditionals for working around non-GNU environments */
+#if defined(__sgi)
+#include <sys/types.h>
+#define dirfd(dirp)	((dirp)->dd_fd)
+#   define        _INCLUDE_POSIX_SOURCE
+#   define __errno_location() 	(&errno)
+#endif
 #if defined(hpux)
 #   define        _INCLUDE_POSIX_SOURCE
 #   define __errno_location() 	(&errno)
diff -N -r -u -w rpm-4.15.0/python/header-py.c rpm-4.15.0-patched/python/header-py.c
--- rpm-4.15.0/python/header-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/header-py.c	2019-10-04 10:48:16.540557800 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmlib.h>		/* rpmvercmp */
diff -N -r -u -w rpm-4.15.0/python/rpmarchive-py.c rpm-4.15.0-patched/python/rpmarchive-py.c
--- rpm-4.15.0/python/rpmarchive-py.c	2019-06-26 15:17:31.443985000 +0000
+++ rpm-4.15.0-patched/python/rpmarchive-py.c	2019-10-04 10:48:36.626249320 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmtypes.h>
diff -N -r -u -w rpm-4.15.0/python/rpmds-py.c rpm-4.15.0-patched/python/rpmds-py.c
--- rpm-4.15.0/python/rpmds-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/rpmds-py.c	2019-10-04 10:48:54.921881160 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmtypes.h>
diff -N -r -u -w rpm-4.15.0/python/rpmfd-py.c rpm-4.15.0-patched/python/rpmfd-py.c
--- rpm-4.15.0/python/rpmfd-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/rpmfd-py.c	2019-10-04 10:49:09.218152480 +0000
@@ -1,3 +1,9 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
 
 #include "rpmsystem-py.h"
 #include <rpm/rpmstring.h>
diff -N -r -u -w rpm-4.15.0/python/rpmfi-py.c rpm-4.15.0-patched/python/rpmfi-py.c
--- rpm-4.15.0/python/rpmfi-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/rpmfi-py.c	2019-10-04 10:49:22.065080680 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmtypes.h>
diff -N -r -u -w rpm-4.15.0/python/rpmfiles-py.c rpm-4.15.0-patched/python/rpmfiles-py.c
--- rpm-4.15.0/python/rpmfiles-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/rpmfiles-py.c	2019-10-04 10:49:38.048790680 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmtypes.h>
diff -N -r -u -w rpm-4.15.0/python/rpmii-py.c rpm-4.15.0-patched/python/rpmii-py.c
--- rpm-4.15.0/python/rpmii-py.c	2019-09-26 10:44:40.739644000 +0000
+++ rpm-4.15.0-patched/python/rpmii-py.c	2019-10-04 10:50:25.479077360 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmdb.h>
diff -N -r -u -w rpm-4.15.0/python/rpmkeyring-py.c rpm-4.15.0-patched/python/rpmkeyring-py.c
--- rpm-4.15.0/python/rpmkeyring-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmkeyring-py.c	2019-10-04 10:49:53.344407440 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 #include <rpm/rpmkeyring.h>
 #include "rpmkeyring-py.h"
diff -N -r -u -w rpm-4.15.0/python/rpmmacro-py.c rpm-4.15.0-patched/python/rpmmacro-py.c
--- rpm-4.15.0/python/rpmmacro-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmmacro-py.c	2019-10-04 10:50:51.333886240 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmmacro.h>
diff -N -r -u -w rpm-4.15.0/python/rpmmi-py.c rpm-4.15.0-patched/python/rpmmi-py.c
--- rpm-4.15.0/python/rpmmi-py.c	2019-09-26 10:44:40.740644000 +0000
+++ rpm-4.15.0-patched/python/rpmmi-py.c	2019-10-04 10:50:05.847363520 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmdb.h>
diff -N -r -u -w rpm-4.15.0/python/rpmmodule.c rpm-4.15.0-patched/python/rpmmodule.c
--- rpm-4.15.0/python/rpmmodule.c	2019-09-26 10:44:40.740644000 +0000
+++ rpm-4.15.0-patched/python/rpmmodule.c	2019-10-04 10:47:34.100825240 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <rpm/rpmlib.h>		/* rpmMachineScore, rpmReadConfigFiles */
diff -N -r -u -w rpm-4.15.0/python/rpmps-py.c rpm-4.15.0-patched/python/rpmps-py.c
--- rpm-4.15.0/python/rpmps-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmps-py.c	2019-10-04 10:50:38.834188120 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include "rpmps-py.h"
diff -N -r -u -w rpm-4.15.0/python/rpmstrpool-py.c rpm-4.15.0-patched/python/rpmstrpool-py.c
--- rpm-4.15.0/python/rpmstrpool-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmstrpool-py.c	2019-10-04 10:51:03.653041840 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 #include <rpm/rpmstrpool.h>
 #include "rpmstrpool-py.h"
diff -N -r -u -w rpm-4.15.0/python/rpmtd-py.c rpm-4.15.0-patched/python/rpmtd-py.c
--- rpm-4.15.0/python/rpmtd-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmtd-py.c	2019-10-04 10:51:15.229705520 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 /** \ingroup py_c
  * \file python/rpmtd-py.c
  */
diff -N -r -u -w rpm-4.15.0/python/rpmte-py.c rpm-4.15.0-patched/python/rpmte-py.c
--- rpm-4.15.0/python/rpmte-py.c	2019-06-26 15:17:31.444985000 +0000
+++ rpm-4.15.0-patched/python/rpmte-py.c	2019-10-04 10:51:27.329502720 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include "header-py.h"	/* XXX tagNumFromPyObject */
diff -N -r -u -w rpm-4.15.0/python/rpmts-py.c rpm-4.15.0-patched/python/rpmts-py.c
--- rpm-4.15.0/python/rpmts-py.c	2019-09-26 10:44:40.740644000 +0000
+++ rpm-4.15.0-patched/python/rpmts-py.c	2019-10-04 10:51:37.868881440 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include <fcntl.h>
diff -N -r -u -w rpm-4.15.0/python/spec-py.c rpm-4.15.0-patched/python/spec-py.c
--- rpm-4.15.0/python/spec-py.c	2019-06-26 15:17:31.445985000 +0000
+++ rpm-4.15.0-patched/python/spec-py.c	2019-10-04 10:51:49.566464160 +0000
@@ -1,3 +1,10 @@
+#if defined(__sgi)
+#include <unistd.h>
+#undef _ABIAPI
+#include <sys/time.h>
+#define _ABIAPI 1
+#endif
+
 #include "rpmsystem-py.h"
 
 #include "rpmts-py.h"
diff -N -r -u -w rpm-4.15.0/rpmio/macro.c rpm-4.15.0-patched/rpmio/macro.c
--- rpm-4.15.0/rpmio/macro.c	2019-09-09 08:56:53.374788000 +0000
+++ rpm-4.15.0-patched/rpmio/macro.c	2019-10-04 09:12:11.808104000 +0000
@@ -512,7 +512,11 @@
 #endif
     /* Fallback to sysconf() if the above isn't supported or didn't work */
     if (ncpus < 1)
+#if defined(__sgi)
+	ncpus = sysconf(_SC_NPROC_ONLN);
+#else
 	ncpus = sysconf(_SC_NPROCESSORS_ONLN);
+#endif
     /* If all else fails, there's always the one we're running on... */
     if (ncpus < 1)
 	ncpus = 1;
diff -N -r -u -w rpm-4.15.0/system.h rpm-4.15.0-patched/system.h
--- rpm-4.15.0/system.h	2019-06-26 15:17:31.455985000 +0000
+++ rpm-4.15.0-patched/system.h	2019-10-04 09:12:11.810278080 +0000
@@ -106,6 +106,9 @@
 # define xsetprogname(pn)
   extern const char *__progname;
 # define xgetprogname(pn) __progname
+#elif defined(__sgi)
+# define xsetprogname(pn)
+# define xgetprogname(pn) getprogname
 #else
 # error "Did not find any sutable implementation of xsetprogname/xgetprogname"
 #endif
